{
  "version": 3,
  "sources": ["../../src/components/menu-item/submenu-controller.ts"],
  "sourcesContent": ["import { createRef, ref, type Ref } from 'lit/directives/ref.js';\r\nimport { type HasSlotController } from '../../internal/slot';\r\nimport { html } from 'lit';\r\nimport { type LocalizeController } from '../../utilities/localize';\r\nimport type { ReactiveController, ReactiveControllerHost } from 'lit';\r\nimport type MenuItem from './menu-item';\r\nimport type Popup from '../popup/popup';\r\n\r\n/** A reactive controller to manage the registration of event listeners for submenus. */\r\nexport class SubmenuController implements ReactiveController {\r\n  private host: ReactiveControllerHost & MenuItem;\r\n  private popupRef: Ref<Popup> = createRef();\r\n  private enableSubmenuTimer = -1;\r\n  private isConnected = false;\r\n  private isPopupConnected = false;\r\n  private skidding = 0;\r\n  private readonly hasSlotController: HasSlotController;\r\n  private readonly localize: LocalizeController;\r\n  private readonly submenuOpenDelay = 100;\r\n\r\n  constructor(\r\n    host: ReactiveControllerHost & MenuItem,\r\n    hasSlotController: HasSlotController,\r\n    localize: LocalizeController\r\n  ) {\r\n    (this.host = host).addController(this);\r\n    this.hasSlotController = hasSlotController;\r\n    this.localize = localize;\r\n  }\r\n\r\n  hostConnected() {\r\n    if (this.hasSlotController.test('submenu') && !this.host.disabled) {\r\n      this.addListeners();\r\n    }\r\n  }\r\n\r\n  hostDisconnected() {\r\n    this.removeListeners();\r\n  }\r\n\r\n  hostUpdated() {\r\n    if (this.hasSlotController.test('submenu') && !this.host.disabled) {\r\n      this.addListeners();\r\n      this.updateSkidding();\r\n    } else {\r\n      this.removeListeners();\r\n    }\r\n  }\r\n\r\n  private addListeners() {\r\n    if (!this.isConnected) {\r\n      this.host.addEventListener('mousemove', this.handleMouseMove);\r\n      this.host.addEventListener('mouseover', this.handleMouseOver);\r\n      this.host.addEventListener('keydown', this.handleKeyDown);\r\n      this.host.addEventListener('click', this.handleClick);\r\n      this.host.addEventListener('focusout', this.handleFocusOut);\r\n      this.isConnected = true;\r\n    }\r\n\r\n    // The popup does not seem to get wired when the host is\r\n    // connected, so manage its listeners separately.\r\n    if (!this.isPopupConnected) {\r\n      if (this.popupRef.value) {\r\n        this.popupRef.value.addEventListener('mouseover', this.handlePopupMouseover);\r\n        this.popupRef.value.addEventListener('koerber-reposition', this.handlePopupReposition);\r\n        this.isPopupConnected = true;\r\n      }\r\n    }\r\n  }\r\n\r\n  private removeListeners() {\r\n    if (this.isConnected) {\r\n      this.host.removeEventListener('mousemove', this.handleMouseMove);\r\n      this.host.removeEventListener('mouseover', this.handleMouseOver);\r\n      this.host.removeEventListener('keydown', this.handleKeyDown);\r\n      this.host.removeEventListener('click', this.handleClick);\r\n      this.host.removeEventListener('focusout', this.handleFocusOut);\r\n      this.isConnected = false;\r\n    }\r\n    if (this.isPopupConnected) {\r\n      if (this.popupRef.value) {\r\n        this.popupRef.value.removeEventListener('mouseover', this.handlePopupMouseover);\r\n        this.popupRef.value.removeEventListener('koerber-reposition', this.handlePopupReposition);\r\n        this.isPopupConnected = false;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Set the safe triangle cursor position\r\n  private handleMouseMove = (event: MouseEvent) => {\r\n    this.host.style.setProperty('--safe-triangle-cursor-x', `${event.clientX}px`);\r\n    this.host.style.setProperty('--safe-triangle-cursor-y', `${event.clientY}px`);\r\n  };\r\n\r\n  private handleMouseOver = () => {\r\n    if (this.hasSlotController.test('submenu')) {\r\n      this.enableSubmenu();\r\n    }\r\n  };\r\n\r\n  private handleSubmenuEntry(event: KeyboardEvent) {\r\n    // Pass focus to the first menu-item in the submenu.\r\n    const submenuSlot: HTMLSlotElement | null = this.host.renderRoot.querySelector(\"slot[name='submenu']\");\r\n\r\n    // Missing slot\r\n    if (!submenuSlot) {\r\n      console.error('Cannot activate a submenu if no corresponding menuitem can be found.', this);\r\n      return;\r\n    }\r\n\r\n    // Menus\r\n    let menuItems: NodeListOf<Element> | null = null;\r\n    for (const elt of submenuSlot.assignedElements()) {\r\n      menuItems = elt.querySelectorAll(\"koerber-menu-item, [role^='menuitem']\");\r\n      if (menuItems.length !== 0) {\r\n        break;\r\n      }\r\n    }\r\n\r\n    if (!menuItems || menuItems.length === 0) {\r\n      return;\r\n    }\r\n\r\n    menuItems[0].setAttribute('tabindex', '0');\r\n    for (let i = 1; i !== menuItems.length; ++i) {\r\n      menuItems[i].setAttribute('tabindex', '-1');\r\n    }\r\n\r\n    // Open the submenu (if not open), and set focus to first menuitem.\r\n    if (this.popupRef.value) {\r\n      event.preventDefault();\r\n      event.stopPropagation();\r\n      if (this.popupRef.value.active) {\r\n        if (menuItems[0] instanceof HTMLElement) {\r\n          menuItems[0].focus();\r\n        }\r\n      } else {\r\n        this.enableSubmenu(false);\r\n        this.host.updateComplete.then(() => {\r\n          if (menuItems?.[0] instanceof HTMLElement) {\r\n            menuItems[0].focus();\r\n          }\r\n        });\r\n        this.host.requestUpdate();\r\n      }\r\n    }\r\n  }\r\n\r\n  // Focus on the first menu-item of a submenu.\r\n  private handleKeyDown = (event: KeyboardEvent) => {\r\n    switch (event.key) {\r\n      case 'Escape':\r\n      case 'Tab':\r\n        this.disableSubmenu();\r\n        break;\r\n      case 'ArrowLeft':\r\n        // Either focus is currently on the host element or a child\r\n        if (event.target !== this.host) {\r\n          event.preventDefault();\r\n          event.stopPropagation();\r\n          this.host.focus();\r\n          this.disableSubmenu();\r\n        }\r\n        break;\r\n      case 'ArrowRight':\r\n      case 'Enter':\r\n      case ' ':\r\n        this.handleSubmenuEntry(event);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  };\r\n\r\n  private handleClick = (event: MouseEvent) => {\r\n    // Clicking on the item which heads the menu does nothing, otherwise hide submenu and propagate\r\n    if (event.target === this.host) {\r\n      // event.preventDefault();\r\n      // event.stopPropagation();\r\n    } else if (\r\n      event.target instanceof Element &&\r\n      (event.target.tagName === 'KOERBER-MENU-ITEM' || event.target.role?.startsWith('menuitem'))\r\n    ) {\r\n      this.disableSubmenu();\r\n      event.preventDefault();\r\n      event.stopPropagation();\r\n    }\r\n  };\r\n\r\n  // Close this submenu on focus outside of the parent or any descendants.\r\n  private handleFocusOut = (event: FocusEvent) => {\r\n    if (event.relatedTarget && event.relatedTarget instanceof Element && this.host.contains(event.relatedTarget)) {\r\n      return;\r\n    }\r\n    this.disableSubmenu();\r\n  };\r\n\r\n  // Prevent the parent menu-item from getting focus on mouse movement on the submenu\r\n  private handlePopupMouseover = (event: MouseEvent) => {\r\n    event.stopPropagation();\r\n  };\r\n\r\n  // Set the safe triangle values for the submenu when the position changes\r\n  private handlePopupReposition = () => {\r\n    const submenuSlot: HTMLSlotElement | null = this.host.renderRoot.querySelector(\"slot[name='submenu']\");\r\n    const menu = submenuSlot?.assignedElements({ flatten: true }).filter(el => el.localName === 'koerber-menu')[0];\r\n    const isRtl = this.localize.dir() === 'rtl';\r\n\r\n    if (!menu) {\r\n      return;\r\n    }\r\n\r\n    const { left, top, width, height } = menu.getBoundingClientRect();\r\n\r\n    this.host.style.setProperty('--safe-triangle-submenu-start-x', `${isRtl ? left + width : left}px`);\r\n    this.host.style.setProperty('--safe-triangle-submenu-start-y', `${top}px`);\r\n    this.host.style.setProperty('--safe-triangle-submenu-end-x', `${isRtl ? left + width : left}px`);\r\n    this.host.style.setProperty('--safe-triangle-submenu-end-y', `${top + height}px`);\r\n  };\r\n\r\n  private setSubmenuState(state: boolean) {\r\n    if (this.popupRef.value) {\r\n      if (this.popupRef.value.active !== state) {\r\n        this.popupRef.value.active = state;\r\n        this.host.requestUpdate();\r\n      }\r\n    }\r\n  }\r\n\r\n  // Shows the submenu. Supports disabling the opening delay, e.g. for keyboard events that want to set the focus to the\r\n  // newly opened menu.\r\n  private enableSubmenu(delay = true) {\r\n    if (delay) {\r\n      window.clearTimeout(this.enableSubmenuTimer);\r\n      this.enableSubmenuTimer = window.setTimeout(() => {\r\n        this.setSubmenuState(true);\r\n      }, this.submenuOpenDelay);\r\n    } else {\r\n      this.setSubmenuState(true);\r\n    }\r\n  }\r\n\r\n  private disableSubmenu() {\r\n    window.clearTimeout(this.enableSubmenuTimer);\r\n    this.setSubmenuState(false);\r\n  }\r\n\r\n  // Calculate the space the top of a menu takes-up, for aligning the popup menu-item with the activating element.\r\n  private updateSkidding(): void {\r\n    // .computedStyleMap() not always available.\r\n    if (!this.host.parentElement?.computedStyleMap) {\r\n      return;\r\n    }\r\n    const styleMap: StylePropertyMapReadOnly = this.host.parentElement.computedStyleMap();\r\n    const attrs: string[] = ['padding-top', 'border-top-width', 'margin-top'];\r\n\r\n    const skidding = attrs.reduce((accumulator, attr) => {\r\n      const styleValue: CSSStyleValue = styleMap.get(attr) ?? new CSSUnitValue(0, 'px');\r\n      const unitValue = styleValue instanceof CSSUnitValue ? styleValue : new CSSUnitValue(0, 'px');\r\n      const pxValue = unitValue.to('px');\r\n      return accumulator - pxValue.value;\r\n    }, 0);\r\n\r\n    this.skidding = skidding;\r\n  }\r\n\r\n  isExpanded(): boolean {\r\n    return this.popupRef.value ? this.popupRef.value.active : false;\r\n  }\r\n\r\n  renderSubmenu() {\r\n    const isLtr = this.localize.dir() === 'ltr';\r\n\r\n    // Always render the slot, but conditionally render the outer <sl-popup>\r\n    if (!this.isConnected) {\r\n      return html` <slot name=\"submenu\" hidden></slot> `;\r\n    }\r\n\r\n    return html`\r\n      <koerber-popup\r\n        ${ref(this.popupRef)}\r\n        placement=${isLtr ? 'right-start' : 'left-start'}\r\n        anchor=\"anchor\"\r\n        distance=\"4\"\r\n        flip\r\n        flip-fallback-strategy=\"best-fit\"\r\n        skidding=\"${this.skidding}\"\r\n        strategy=\"fixed\"\r\n      >\r\n        <slot name=\"submenu\"></slot>\r\n      </koerber-popup>\r\n    `;\r\n  }\r\n}\r\n"],
  "mappings": ";AAAA,SAAS,WAAW,WAAqB;AAEzC,SAAS,YAAY;AAOd,IAAM,oBAAN,MAAsD;AAAA,EAW3D,YACE,MACA,mBACA,UACA;AAbF,SAAQ,WAAuB,UAAU;AACzC,SAAQ,qBAAqB;AAC7B,SAAQ,cAAc;AACtB,SAAQ,mBAAmB;AAC3B,SAAQ,WAAW;AAGnB,SAAiB,mBAAmB;AAuEpC;AAAA,SAAQ,kBAAkB,CAAC,UAAsB;AAC/C,WAAK,KAAK,MAAM,YAAY,4BAA4B,GAAG,MAAM,OAAO,IAAI;AAC5E,WAAK,KAAK,MAAM,YAAY,4BAA4B,GAAG,MAAM,OAAO,IAAI;AAAA,IAC9E;AAEA,SAAQ,kBAAkB,MAAM;AAC9B,UAAI,KAAK,kBAAkB,KAAK,SAAS,GAAG;AAC1C,aAAK,cAAc;AAAA,MACrB;AAAA,IACF;AAmDA;AAAA,SAAQ,gBAAgB,CAAC,UAAyB;AAChD,cAAQ,MAAM,KAAK;AAAA,QACjB,KAAK;AAAA,QACL,KAAK;AACH,eAAK,eAAe;AACpB;AAAA,QACF,KAAK;AAEH,cAAI,MAAM,WAAW,KAAK,MAAM;AAC9B,kBAAM,eAAe;AACrB,kBAAM,gBAAgB;AACtB,iBAAK,KAAK,MAAM;AAChB,iBAAK,eAAe;AAAA,UACtB;AACA;AAAA,QACF,KAAK;AAAA,QACL,KAAK;AAAA,QACL,KAAK;AACH,eAAK,mBAAmB,KAAK;AAC7B;AAAA,QACF;AACE;AAAA,MACJ;AAAA,IACF;AAEA,SAAQ,cAAc,CAAC,UAAsB;AA9K/C;AAgLI,UAAI,MAAM,WAAW,KAAK,MAAM;AAAA,MAGhC,WACE,MAAM,kBAAkB,YACvB,MAAM,OAAO,YAAY,yBAAuB,WAAM,OAAO,SAAb,mBAAmB,WAAW,eAC/E;AACA,aAAK,eAAe;AACpB,cAAM,eAAe;AACrB,cAAM,gBAAgB;AAAA,MACxB;AAAA,IACF;AAGA;AAAA,SAAQ,iBAAiB,CAAC,UAAsB;AAC9C,UAAI,MAAM,iBAAiB,MAAM,yBAAyB,WAAW,KAAK,KAAK,SAAS,MAAM,aAAa,GAAG;AAC5G;AAAA,MACF;AACA,WAAK,eAAe;AAAA,IACtB;AAGA;AAAA,SAAQ,uBAAuB,CAAC,UAAsB;AACpD,YAAM,gBAAgB;AAAA,IACxB;AAGA;AAAA,SAAQ,wBAAwB,MAAM;AACpC,YAAM,cAAsC,KAAK,KAAK,WAAW,cAAc,sBAAsB;AACrG,YAAM,OAAO,2CAAa,iBAAiB,EAAE,SAAS,KAAK,GAAG,OAAO,QAAM,GAAG,cAAc,gBAAgB;AAC5G,YAAM,QAAQ,KAAK,SAAS,IAAI,MAAM;AAEtC,UAAI,CAAC,MAAM;AACT;AAAA,MACF;AAEA,YAAM,EAAE,MAAM,KAAK,OAAO,OAAO,IAAI,KAAK,sBAAsB;AAEhE,WAAK,KAAK,MAAM,YAAY,mCAAmC,GAAG,QAAQ,OAAO,QAAQ,IAAI,IAAI;AACjG,WAAK,KAAK,MAAM,YAAY,mCAAmC,GAAG,GAAG,IAAI;AACzE,WAAK,KAAK,MAAM,YAAY,iCAAiC,GAAG,QAAQ,OAAO,QAAQ,IAAI,IAAI;AAC/F,WAAK,KAAK,MAAM,YAAY,iCAAiC,GAAG,MAAM,MAAM,IAAI;AAAA,IAClF;AAjME,KAAC,KAAK,OAAO,MAAM,cAAc,IAAI;AACrC,SAAK,oBAAoB;AACzB,SAAK,WAAW;AAAA,EAClB;AAAA,EAEA,gBAAgB;AACd,QAAI,KAAK,kBAAkB,KAAK,SAAS,KAAK,CAAC,KAAK,KAAK,UAAU;AACjE,WAAK,aAAa;AAAA,IACpB;AAAA,EACF;AAAA,EAEA,mBAAmB;AACjB,SAAK,gBAAgB;AAAA,EACvB;AAAA,EAEA,cAAc;AACZ,QAAI,KAAK,kBAAkB,KAAK,SAAS,KAAK,CAAC,KAAK,KAAK,UAAU;AACjE,WAAK,aAAa;AAClB,WAAK,eAAe;AAAA,IACtB,OAAO;AACL,WAAK,gBAAgB;AAAA,IACvB;AAAA,EACF;AAAA,EAEQ,eAAe;AACrB,QAAI,CAAC,KAAK,aAAa;AACrB,WAAK,KAAK,iBAAiB,aAAa,KAAK,eAAe;AAC5D,WAAK,KAAK,iBAAiB,aAAa,KAAK,eAAe;AAC5D,WAAK,KAAK,iBAAiB,WAAW,KAAK,aAAa;AACxD,WAAK,KAAK,iBAAiB,SAAS,KAAK,WAAW;AACpD,WAAK,KAAK,iBAAiB,YAAY,KAAK,cAAc;AAC1D,WAAK,cAAc;AAAA,IACrB;AAIA,QAAI,CAAC,KAAK,kBAAkB;AAC1B,UAAI,KAAK,SAAS,OAAO;AACvB,aAAK,SAAS,MAAM,iBAAiB,aAAa,KAAK,oBAAoB;AAC3E,aAAK,SAAS,MAAM,iBAAiB,sBAAsB,KAAK,qBAAqB;AACrF,aAAK,mBAAmB;AAAA,MAC1B;AAAA,IACF;AAAA,EACF;AAAA,EAEQ,kBAAkB;AACxB,QAAI,KAAK,aAAa;AACpB,WAAK,KAAK,oBAAoB,aAAa,KAAK,eAAe;AAC/D,WAAK,KAAK,oBAAoB,aAAa,KAAK,eAAe;AAC/D,WAAK,KAAK,oBAAoB,WAAW,KAAK,aAAa;AAC3D,WAAK,KAAK,oBAAoB,SAAS,KAAK,WAAW;AACvD,WAAK,KAAK,oBAAoB,YAAY,KAAK,cAAc;AAC7D,WAAK,cAAc;AAAA,IACrB;AACA,QAAI,KAAK,kBAAkB;AACzB,UAAI,KAAK,SAAS,OAAO;AACvB,aAAK,SAAS,MAAM,oBAAoB,aAAa,KAAK,oBAAoB;AAC9E,aAAK,SAAS,MAAM,oBAAoB,sBAAsB,KAAK,qBAAqB;AACxF,aAAK,mBAAmB;AAAA,MAC1B;AAAA,IACF;AAAA,EACF;AAAA,EAcQ,mBAAmB,OAAsB;AAE/C,UAAM,cAAsC,KAAK,KAAK,WAAW,cAAc,sBAAsB;AAGrG,QAAI,CAAC,aAAa;AAChB,cAAQ,MAAM,wEAAwE,IAAI;AAC1F;AAAA,IACF;AAGA,QAAI,YAAwC;AAC5C,eAAW,OAAO,YAAY,iBAAiB,GAAG;AAChD,kBAAY,IAAI,iBAAiB,uCAAuC;AACxE,UAAI,UAAU,WAAW,GAAG;AAC1B;AAAA,MACF;AAAA,IACF;AAEA,QAAI,CAAC,aAAa,UAAU,WAAW,GAAG;AACxC;AAAA,IACF;AAEA,cAAU,CAAC,EAAE,aAAa,YAAY,GAAG;AACzC,aAAS,IAAI,GAAG,MAAM,UAAU,QAAQ,EAAE,GAAG;AAC3C,gBAAU,CAAC,EAAE,aAAa,YAAY,IAAI;AAAA,IAC5C;AAGA,QAAI,KAAK,SAAS,OAAO;AACvB,YAAM,eAAe;AACrB,YAAM,gBAAgB;AACtB,UAAI,KAAK,SAAS,MAAM,QAAQ;AAC9B,YAAI,UAAU,CAAC,aAAa,aAAa;AACvC,oBAAU,CAAC,EAAE,MAAM;AAAA,QACrB;AAAA,MACF,OAAO;AACL,aAAK,cAAc,KAAK;AACxB,aAAK,KAAK,eAAe,KAAK,MAAM;AAClC,eAAI,uCAAY,eAAc,aAAa;AACzC,sBAAU,CAAC,EAAE,MAAM;AAAA,UACrB;AAAA,QACF,CAAC;AACD,aAAK,KAAK,cAAc;AAAA,MAC1B;AAAA,IACF;AAAA,EACF;AAAA,EA0EQ,gBAAgB,OAAgB;AACtC,QAAI,KAAK,SAAS,OAAO;AACvB,UAAI,KAAK,SAAS,MAAM,WAAW,OAAO;AACxC,aAAK,SAAS,MAAM,SAAS;AAC7B,aAAK,KAAK,cAAc;AAAA,MAC1B;AAAA,IACF;AAAA,EACF;AAAA;AAAA;AAAA,EAIQ,cAAc,QAAQ,MAAM;AAClC,QAAI,OAAO;AACT,aAAO,aAAa,KAAK,kBAAkB;AAC3C,WAAK,qBAAqB,OAAO,WAAW,MAAM;AAChD,aAAK,gBAAgB,IAAI;AAAA,MAC3B,GAAG,KAAK,gBAAgB;AAAA,IAC1B,OAAO;AACL,WAAK,gBAAgB,IAAI;AAAA,IAC3B;AAAA,EACF;AAAA,EAEQ,iBAAiB;AACvB,WAAO,aAAa,KAAK,kBAAkB;AAC3C,SAAK,gBAAgB,KAAK;AAAA,EAC5B;AAAA;AAAA,EAGQ,iBAAuB;AAxPjC;AA0PI,QAAI,GAAC,UAAK,KAAK,kBAAV,mBAAyB,mBAAkB;AAC9C;AAAA,IACF;AACA,UAAM,WAAqC,KAAK,KAAK,cAAc,iBAAiB;AACpF,UAAM,QAAkB,CAAC,eAAe,oBAAoB,YAAY;AAExE,UAAM,WAAW,MAAM,OAAO,CAAC,aAAa,SAAS;AAhQzD,UAAAA;AAiQM,YAAM,cAA4BA,MAAA,SAAS,IAAI,IAAI,MAAjB,OAAAA,MAAsB,IAAI,aAAa,GAAG,IAAI;AAChF,YAAM,YAAY,sBAAsB,eAAe,aAAa,IAAI,aAAa,GAAG,IAAI;AAC5F,YAAM,UAAU,UAAU,GAAG,IAAI;AACjC,aAAO,cAAc,QAAQ;AAAA,IAC/B,GAAG,CAAC;AAEJ,SAAK,WAAW;AAAA,EAClB;AAAA,EAEA,aAAsB;AACpB,WAAO,KAAK,SAAS,QAAQ,KAAK,SAAS,MAAM,SAAS;AAAA,EAC5D;AAAA,EAEA,gBAAgB;AACd,UAAM,QAAQ,KAAK,SAAS,IAAI,MAAM;AAGtC,QAAI,CAAC,KAAK,aAAa;AACrB,aAAO;AAAA,IACT;AAEA,WAAO;AAAA;AAAA,UAED,IAAI,KAAK,QAAQ,CAAC;AAAA,oBACR,QAAQ,gBAAgB,YAAY;AAAA;AAAA;AAAA;AAAA;AAAA,oBAKpC,KAAK,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAM/B;AACF;",
  "names": ["_a"]
}
